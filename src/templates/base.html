<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}重庆师范大学师能素质协会{% endblock %}</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    {% block styles %}{% endblock %}
    <style>
        .ai-chat-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #4CAF50;
            color: white;
            border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .ai-chat-button:hover {
            transform: scale(1.1);
            background-color: #45a049;
        }

        .ai-chat-container {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
            flex-direction: column;
            z-index: 1000;
        }

        .ai-chat-header {
            padding: 15px;
            background: #4CAF50;
            color: white;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-chat-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .ai-chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }

        .ai-chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .ai-message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 15px;
            margin-bottom: 10px;
            word-wrap: break-word;
        }

        .ai-message.user {
            background: #e3f2fd;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .ai-message.bot {
            background: #f5f5f5;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .ai-chat-input {
            padding: 15px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
        }

        .ai-chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }

        .ai-chat-input button {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .ai-chat-input button:hover {
            background: #45a049;
        }

        .ai-chat-input button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('main.index') }}">
                <i class="fas fa-graduation-cap me-2"></i>师能素质协会
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main.index') }}">首页</a>
                    </li>
                    {% if current_user.is_authenticated %}
                        {% if current_user.role.name|lower == 'admin' %}
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('admin.dashboard') }}">管理面板</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('admin.activities') }}">活动管理</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('admin.students') }}">学生管理</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('admin.statistics') }}">数据统计</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('admin.manage_tags') }}">标签管理</a>
                            </li>
                        {% else %}
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('student.dashboard') }}">我的面板</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('student.activities') }}">浏览活动</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('student.my_activities') }}">我的活动</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('student.points') }}">我的积分</a>
                            </li>
                        {% endif %}
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('main.about') }}">关于我们</a>
                        </li>
                    {% endif %}
                </ul>
                <div class="d-flex">
                    <form class="d-flex me-2" action="{{ url_for('main.search') }}" method="get">
                        <input class="form-control me-2" type="search" name="q" placeholder="搜索活动..." aria-label="Search">
                        <button class="btn btn-outline-light" type="submit">搜索</button>
                    </form>
                    <ul class="navbar-nav">
                        {% if current_user.is_authenticated %}
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-user-circle me-1"></i>
                                    {% if current_user.role.name|lower == 'student' and current_user.student_info %}
                                        {{ current_user.student_info.real_name }}
                                    {% else %}
                                        {{ current_user.username }}
                                    {% endif %}
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    {% if current_user.role.name|lower == 'student' %}
                                        <li><a class="dropdown-item" href="{{ url_for('student.profile') }}">个人资料</a></li>
                                    {% endif %}
                                    <li><a class="dropdown-item" href="{{ url_for('auth.change_password') }}">修改密码</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}">退出登录</a></li>
                                </ul>
                            </li>
                        {% else %}
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('auth.login') }}">登录</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('auth.register') }}">注册</a>
                            </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>

    <footer class="footer mt-5 py-3 bg-light">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>重庆师范大学师能素质协会</h5>
                    <p>致力于提升师范生专业素养和教学能力的学生组织</p>
                </div>
                <div class="col-md-3">
                    <h5>快速链接</h5>
                    <ul class="list-unstyled">
                        <li><a href="{{ url_for('main.index') }}">首页</a></li>
                        <li><a href="{{ url_for('main.about') }}">关于我们</a></li>
                        {% if not current_user.is_authenticated %}
                            <li><a href="{{ url_for('auth.login') }}">登录</a></li>
                            <li><a href="{{ url_for('auth.register') }}">注册</a></li>
                        {% endif %}
                    </ul>
                </div>
                <div class="col-md-3">
                    <h5>联系我们</h5>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-map-marker-alt me-2"></i>重庆市沙坪坝区大学城中路37号</li>
                        <li><i class="fab fa-qq me-2"></i>QQ群：995213034</li>
                        <li><i class="fas fa-phone me-2"></i>023-65362779</li>
                    </ul>
                </div>
            </div>
            <hr>
            <div class="text-center">
                <p>&copy; {{ now.year }} 重庆师范大学师能素质协会. 保留所有权利.</p>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    {% block scripts %}{% endblock %}

    <button class="ai-chat-button" onclick="toggleAIChat()">
        <i class="fas fa-robot"></i>
    </button>

    <div class="ai-chat-container" id="aiChatContainer">
        <div class="ai-chat-header">
            <h3>智能助手</h3>
            <button class="ai-chat-close" onclick="toggleAIChat()">&times;</button>
        </div>
        <div class="ai-chat-messages" id="aiChatMessages">
            {% if current_user.is_authenticated %}
            <div class="ai-message bot">
                你好！我是智能助手，有什么可以帮你的吗？
            </div>
            {% else %}
            <div class="ai-message bot">
                您好！AI助手功能需要登录后使用。请先<a href="{{ url_for('auth.login') }}">登录</a>或<a href="{{ url_for('auth.register') }}">注册</a>。
            </div>
            {% endif %}
        </div>
        <div class="ai-chat-input">
            <input type="text" id="aiChatInput" placeholder="输入你的问题..." onkeypress="handleAIChatInput(event)" {% if not current_user.is_authenticated %}disabled{% endif %}>
            <button onclick="sendAIMessage()" id="aiSendButton" {% if not current_user.is_authenticated %}disabled{% endif %}>发送</button>
        </div>
    </div>

    <script>
        function toggleAIChat() {
            const container = document.getElementById('aiChatContainer');
            container.style.display = container.style.display === 'none' ? 'flex' : 'none';
        }

        function handleAIChatInput(event) {
            if (event.key === 'Enter') {
                sendAIMessage();
            }
        }

        function sendAIMessage() {
            {% if not current_user.is_authenticated %}
                return;
            {% endif %}
            
            const input = document.getElementById('aiChatInput');
            const message = input.value.trim();
            if (!message) return;

            // 添加用户消息
            addMessage(message, 'user');
            input.value = '';

            // 禁用输入和按钮
            input.disabled = true;
            document.getElementById('aiSendButton').disabled = true;

            // 创建AI消息容器
            const messagesContainer = document.getElementById('aiChatMessages');
            const aiMessageDiv = document.createElement('div');
            aiMessageDiv.className = 'ai-message bot';
            messagesContainer.appendChild(aiMessageDiv);

            // 创建 EventSource 连接
            const eventSource = new EventSource(`/api/ai_chat?message=${encodeURIComponent(message)}&role=student`);

            // 处理消息
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.error) {
                    aiMessageDiv.textContent = `错误: ${data.error}`;
                    eventSource.close();
                    input.disabled = false;
                    document.getElementById('aiSendButton').disabled = false;
                    input.focus();
                } else if (data.content) {
                    aiMessageDiv.textContent += data.content;
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            };

            // 处理错误
            eventSource.onerror = function() {
                eventSource.close();
                if (!aiMessageDiv.textContent) {
                    aiMessageDiv.textContent = '抱歉，服务出现错误，请稍后再试。';
                }
                input.disabled = false;
                document.getElementById('aiSendButton').disabled = false;
                input.focus();
            };
        }

        function addMessage(text, type) {
            const messagesContainer = document.getElementById('aiChatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ${type}`;
            messageDiv.textContent = text;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    </script>
</body>
</html>
