{% extends "base.html" %}

{% block title %}数据库状态监控{% endblock %}

{% block content %}
<!-- CSRF Token for AJAX requests -->
<meta name="csrf-token" content="{{ csrf_token() }}">

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-database me-2"></i>数据库状态监控</h2>
                <div>
                    <button class="btn btn-outline-primary" onclick="refreshStatus()" data-no-loading="true">
                        <i class="fas fa-sync-alt me-2"></i>刷新状态
                    </button>
                    <button class="btn btn-outline-info btn-sm ms-2" onclick="testTimeConversion()" data-no-loading="true">
                        测试时间转换
                    </button>
                    <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>返回管理面板
                    </a>
                </div>
            </div>

            <!-- 数据库状态概览 -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-server me-2"></i>主数据库 (Render)</h5>
                        </div>
                        <div class="card-body">
                            <div id="primary-db-status">
                                <div class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">检测中...</span>
                                    </div>
                                    <p class="mt-2">检测连接状态...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card border-info">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="fas fa-cloud me-2"></i>备份数据库 (ClawCloud)</h5>
                        </div>
                        <div class="card-body">
                            <div id="backup-db-status">
                                <div class="text-center">
                                    <div class="spinner-border text-info" role="status">
                                        <span class="visually-hidden">检测中...</span>
                                    </div>
                                    <p class="mt-2">检测连接状态...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 同步操作 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-sync me-2"></i>数据库同步操作</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-grid gap-2">
                                <button class="btn btn-success" onclick="syncToBackup()" id="syncToBackupBtn" data-no-loading="true">
                                    <i class="fas fa-cloud-upload-alt me-2"></i>备份到ClawCloud
                                </button>
                                <small class="text-muted">将主数据库的数据备份到ClawCloud</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-grid gap-2">
                                <button class="btn btn-warning" onclick="restoreFromBackup()" id="restoreFromBackupBtn" data-no-loading="true">
                                    <i class="fas fa-cloud-download-alt me-2"></i>从ClawCloud恢复
                                </button>
                                <small class="text-muted">从ClawCloud恢复数据到主数据库</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 同步日志 -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>同步日志</h5>
                </div>
                <div class="card-body">
                    <div id="sync-log">
                        <p class="text-muted">暂无同步日志</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 刷新数据库状态
function refreshStatus() {
    checkDatabaseStatus();
    loadSyncLog();
}

// 测试时间转换函数
function testTimeConversion() {
    const testTimestamps = [
        '2025-07-23T01:37:29+08:00',
        '2025-07-23 01:37:29',
        '2025/07/23 01:37:29',
        '2025-07-23T01:37:29',
        '2025-07-23 09:37:29+08:00'
    ];

    console.log('=== 时间转换测试 ===');
    testTimestamps.forEach(timestamp => {
        try {
            let ts;
            if (timestamp.includes('+08:00') || timestamp.includes('+0800')) {
                ts = new Date(timestamp);
            } else {
                let timeStr = timestamp.replace(' ', 'T').replace(/\//g, '-');
                if (!timeStr.includes('+')) {
                    timeStr += '+08:00';
                }
                ts = new Date(timeStr);
            }

            const beijingTime = ts.toLocaleString('zh-CN', {
                timeZone: 'Asia/Shanghai',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });

            console.log(`${timestamp} -> ${beijingTime}`);
        } catch (e) {
            console.error(`${timestamp} -> 解析失败:`, e);
        }
    });
    console.log('=== 测试完成 ===');
}

// 请求去重和频率控制
let isCheckingStatus = false;
let lastStatusCheck = 0;
const STATUS_CHECK_COOLDOWN = 10000; // 10秒冷却时间

// 检查数据库状态
function checkDatabaseStatus() {
    const now = Date.now();

    // 防止重复请求
    if (isCheckingStatus) {
        console.log('数据库状态检查正在进行中，跳过此次请求');
        return;
    }

    // 频率限制
    if (now - lastStatusCheck < STATUS_CHECK_COOLDOWN) {
        console.log('数据库状态检查频率限制，跳过此次请求');
        return;
    }

    isCheckingStatus = true;
    lastStatusCheck = now;

    fetch('/admin/api/database-status')
        .then(response => {
            if (response.status === 429) {
                throw new Error('请求过于频繁，请稍后再试');
            }

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            // 检查响应内容类型
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('服务器返回了非JSON响应');
            }

            return response.json();
        })
        .then(data => {
            updatePrimaryStatus(data);
            updateBackupStatus(data);
        })
        .catch(error => {
            console.error('获取数据库状态失败:', error);

            if (error.message.includes('429') || error.message.includes('频繁')) {
                console.log('API请求频率过高，暂停状态检查');
                // 暂停更长时间
                lastStatusCheck = now + 30000; // 额外暂停30秒
            } else if (!error.message.includes('JSON')) {
                // 只在非JSON错误时显示错误信息
                showError('获取数据库状态失败: ' + error.message);
            }
        })
        .finally(() => {
            isCheckingStatus = false;
        });
}

// 更新主数据库状态
function updatePrimaryStatus(data) {
    const container = document.getElementById('primary-db-status');
    const isConnected = data.primary;
    const latency = data.primary_latency;
    
    let statusHtml = '';
    if (isConnected) {
        statusHtml = `
            <div class="text-success">
                <i class="fas fa-check-circle fa-2x mb-2"></i>
                <h6>连接正常</h6>
                <p class="mb-0">延迟: ${latency ? latency.toFixed(2) + 'ms' : '未知'}</p>
            </div>
        `;
    } else {
        statusHtml = `
            <div class="text-danger">
                <i class="fas fa-times-circle fa-2x mb-2"></i>
                <h6>连接失败</h6>
                <p class="mb-0">无法连接到主数据库</p>
            </div>
        `;
    }
    
    container.innerHTML = statusHtml;
}

// 更新备份数据库状态
function updateBackupStatus(data) {
    const container = document.getElementById('backup-db-status');
    const isConnected = data.backup;
    const latency = data.backup_latency;
    
    let statusHtml = '';
    if (data.backup_configured) {
        if (isConnected) {
            statusHtml = `
                <div class="text-success">
                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                    <h6>连接正常</h6>
                    <p class="mb-0">延迟: ${latency ? latency.toFixed(2) + 'ms' : '未知'}</p>
                </div>
            `;
        } else {
            statusHtml = `
                <div class="text-danger">
                    <i class="fas fa-times-circle fa-2x mb-2"></i>
                    <h6>连接失败</h6>
                    <p class="mb-0">无法连接到备份数据库</p>
                </div>
            `;
        }
    } else {
        statusHtml = `
            <div class="text-warning">
                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                <h6>未配置</h6>
                <p class="mb-0">备份数据库未配置</p>
            </div>
        `;
    }
    
    container.innerHTML = statusHtml;
}

// 同步到备份数据库
function syncToBackup() {
    const btn = document.getElementById('syncToBackupBtn');
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>备份中...';
    btn.disabled = true;
    
    // 获取CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

    if (!csrfToken) {
        showError('无法获取CSRF token');
        btn.innerHTML = originalText;
        btn.disabled = false;
        return;
    }

    // 创建AbortController用于超时控制
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 180000); // 3分钟超时

    fetch('/admin/api/sync-to-backup', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        signal: controller.signal
    })
    .then(response => {
        clearTimeout(timeoutId);

        // 检查响应状态
        if (response.status === 524) {
            throw new Error('请求超时，但备份可能仍在进行中，请稍后查看同步日志');
        }

        if (response.status === 523) {
            throw new Error('服务器暂时不可达，备份可能仍在后台进行，请稍后查看同步日志');
        }

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        // 检查响应内容类型
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('服务器返回了非JSON响应，可能是HTML错误页面');
        }

        return response.json();
    })
    .then(data => {
        if (data.success) {
            showSuccess('数据已成功备份到ClawCloud');
            loadSyncLog();
        } else {
            showError('备份失败: ' + (data.message || '未知错误'));
        }
    })
    .catch(error => {
        clearTimeout(timeoutId);
        console.error('备份失败:', error);

        if (error.name === 'AbortError') {
            showError('备份请求超时，但操作可能仍在后台进行，请稍后查看同步日志');
        } else if (error.message.includes('524') || error.message.includes('超时')) {
            showError('备份请求超时，请稍后查看同步日志确认结果');
        } else if (error.message.includes('523') || error.message.includes('不可达')) {
            showError('服务器暂时不可达，备份可能仍在后台进行，请稍后查看同步日志');
        } else if (error.message.includes('JSON')) {
            showError('服务器响应格式错误，请检查服务器状态');
        } else {
            showError('备份操作失败: ' + error.message);
        }

        // 超时后刷新同步日志，可能操作已完成
        setTimeout(() => {
            loadSyncLog();
        }, 5000);
    })
    .finally(() => {
        clearTimeout(timeoutId);
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

// 从备份数据库恢复
function restoreFromBackup() {
    if (!confirm('确定要从ClawCloud恢复数据吗？这将覆盖主数据库的当前数据！')) {
        return;
    }
    
    const btn = document.getElementById('restoreFromBackupBtn');
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>恢复中...';
    btn.disabled = true;
    
    // 获取CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

    if (!csrfToken) {
        showError('无法获取CSRF token');
        btn.innerHTML = originalText;
        btn.disabled = false;
        return;
    }

    // 创建AbortController用于超时控制
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 180000); // 3分钟超时

    fetch('/admin/api/restore-from-backup', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        signal: controller.signal
    })
    .then(response => {
        clearTimeout(timeoutId);

        // 检查响应状态
        if (response.status === 524) {
            throw new Error('请求超时，但恢复可能仍在进行中，请稍后查看同步日志');
        }

        if (response.status === 523) {
            throw new Error('服务器暂时不可达，恢复可能仍在后台进行，请稍后查看同步日志');
        }

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        // 检查响应内容类型
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('服务器返回了非JSON响应，可能是HTML错误页面');
        }

        return response.json();
    })
    .then(data => {
        if (data.success) {
            showSuccess('数据已从ClawCloud成功恢复');
            loadSyncLog();
        } else {
            showError('恢复失败: ' + (data.message || '未知错误'));
        }
    })
    .catch(error => {
        clearTimeout(timeoutId);
        console.error('恢复失败:', error);

        if (error.name === 'AbortError') {
            showError('恢复请求超时，但操作可能仍在后台进行，请稍后查看同步日志');
        } else if (error.message.includes('524') || error.message.includes('超时')) {
            showError('恢复请求超时，请稍后查看同步日志确认结果');
        } else if (error.message.includes('523') || error.message.includes('不可达')) {
            showError('服务器暂时不可达，恢复可能仍在后台进行，请稍后查看同步日志');
        } else if (error.message.includes('JSON')) {
            showError('服务器响应格式错误，请检查服务器状态');
        } else {
            showError('恢复操作失败: ' + error.message);
        }

        // 超时后刷新同步日志，可能操作已完成
        setTimeout(() => {
            loadSyncLog();
        }, 5000);
    })
    .finally(() => {
        clearTimeout(timeoutId);
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

// 加载同步日志
function loadSyncLog() {
    fetch('/admin/api/sync-log')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('sync-log');
            if (data.logs && data.logs.length > 0) {
                let logHtml = '<div class="table-responsive"><table class="table table-sm">';
                logHtml += '<thead><tr><th>时间</th><th>操作</th><th>状态</th><th>详情</th></tr></thead><tbody>';
                
                data.logs.slice(-10).reverse().forEach(log => {
                    const statusClass = log.status === '成功' ? 'text-success' :
                                       log.status === '失败' ? 'text-danger' : 'text-warning';

                    // 强制北京时间显示 - 简化且更可靠的方法
                    let beijingTime;
                    try {
                        let timestamp;

                        console.log('原始时间戳:', log.timestamp);

                        // 强制处理：假设所有时间戳都是北京时间
                        if (log.timestamp.includes('+08:00') || log.timestamp.includes('+0800')) {
                            // 已包含时区信息
                            timestamp = new Date(log.timestamp);
                        } else {
                            // 没有时区信息，强制假设是北京时间
                            let timeStr = log.timestamp;

                            // 标准化格式
                            if (!timeStr.includes('T')) {
                                timeStr = timeStr.replace(' ', 'T');
                            }

                            // 添加北京时区
                            if (!timeStr.includes('+')) {
                                timeStr += '+08:00';
                            }

                            timestamp = new Date(timeStr);
                        }

                        // 如果解析失败，尝试另一种方法
                        if (isNaN(timestamp.getTime())) {
                            // 解析为UTC时间，然后加8小时转为北京时间
                            timestamp = new Date(log.timestamp);
                            if (!isNaN(timestamp.getTime())) {
                                timestamp.setHours(timestamp.getHours() + 8);
                            }
                        }

                        // 最终验证
                        if (isNaN(timestamp.getTime())) {
                            throw new Error('无法解析时间戳');
                        }

                        // 强制显示为北京时间
                        beijingTime = timestamp.toLocaleString('zh-CN', {
                            timeZone: 'Asia/Shanghai',
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            hour12: false
                        });

                        console.log('时间转换结果:', log.timestamp, '->', beijingTime);

                    } catch (e) {
                        console.error('时间解析失败:', log.timestamp, e);
                        // 如果所有方法都失败，直接显示原始时间戳
                        beijingTime = log.timestamp;
                    }

                    logHtml += `
                        <tr>
                            <td>${beijingTime}</td>
                            <td>${log.action}</td>
                            <td class="${statusClass}">${log.status}</td>
                            <td>${log.details || '-'}</td>
                        </tr>
                    `;
                });
                
                logHtml += '</tbody></table></div>';
                container.innerHTML = logHtml;
            } else {
                container.innerHTML = '<p class="text-muted">暂无同步日志</p>';
            }
        })
        .catch(error => {
            console.error('加载同步日志失败:', error);
        });
}

// 显示成功消息
function showSuccess(message) {
    if (typeof showToast === 'function') {
        showToast(message, 'success');
    } else {
        alert(message);
    }
}

// 显示错误消息
function showError(message) {
    if (typeof showToast === 'function') {
        showToast(message, 'error');
    } else {
        alert(message);
    }
}

// 页面加载时检查状态
document.addEventListener('DOMContentLoaded', function() {
    checkDatabaseStatus();
    loadSyncLog();

    // 每2分钟自动刷新状态（减少API请求频率）
    setInterval(checkDatabaseStatus, 120000);

    // 页面可见性变化时检查状态
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible') {
            // 页面变为可见时，延迟5秒后检查状态
            setTimeout(checkDatabaseStatus, 5000);
        }
    });
});
</script>
{% endblock %}
