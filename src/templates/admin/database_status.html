{% extends "base.html" %}

{% block title %}æ•°æ®åº“çŠ¶æ€ç›‘æ§{% endblock %}

{% block content %}
<!-- CSRF Token for AJAX requests -->
<meta name="csrf-token" content="{{ csrf_token() }}">

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-database me-2"></i>æ•°æ®åº“çŠ¶æ€ç›‘æ§</h2>
                <div>
                    <button class="btn btn-outline-primary" onclick="refreshStatus()" data-no-loading="true">
                        <i class="fas fa-sync-alt me-2"></i>åˆ·æ–°çŠ¶æ€
                    </button>
                    <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>è¿”å›ç®¡ç†é¢æ¿
                    </a>
                </div>
            </div>

            <!-- æ•°æ®åº“çŠ¶æ€æ¦‚è§ˆ -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-server me-2"></i>ä¸»æ•°æ®åº“ (Render)</h5>
                        </div>
                        <div class="card-body">
                            <div id="primary-db-status">
                                <div class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">æ£€æµ‹ä¸­...</span>
                                    </div>
                                    <p class="mt-2">æ£€æµ‹è¿æ¥çŠ¶æ€...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card border-info">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="fas fa-cloud me-2"></i>å¤‡ä»½æ•°æ®åº“ (ClawCloud)</h5>
                        </div>
                        <div class="card-body">
                            <div id="backup-db-status">
                                <div class="text-center">
                                    <div class="spinner-border text-info" role="status">
                                        <span class="visually-hidden">æ£€æµ‹ä¸­...</span>
                                    </div>
                                    <p class="mt-2">æ£€æµ‹è¿æ¥çŠ¶æ€...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åŒæ­¥æ“ä½œ -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-sync me-2"></i>æ•°æ®åº“åŒæ­¥æ“ä½œ</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-grid gap-2">
                                <button class="btn btn-success" onclick="syncToBackup()" id="syncToBackupBtn" data-no-loading="true">
                                    <i class="fas fa-cloud-upload-alt me-2"></i>å¤‡ä»½åˆ°ClawCloud
                                </button>
                                <small class="text-muted">å°†ä¸»æ•°æ®åº“çš„æ•°æ®å¤‡ä»½åˆ°ClawCloud</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-grid gap-2">
                                <button class="btn btn-warning" onclick="restoreFromBackup()" id="restoreFromBackupBtn" data-no-loading="true">
                                    <i class="fas fa-brain me-2"></i>æ™ºèƒ½æ•°æ®åº“è¿ç§»
                                </button>
                                <button class="btn btn-outline-warning btn-sm" onclick="showAdvancedRestore()" data-no-loading="true">
                                    <i class="fas fa-cogs me-1"></i>é«˜çº§æ¢å¤é€‰é¡¹
                                </button>
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    æ™ºèƒ½æ£€æµ‹æ•°æ®åº“çŠ¶æ€ï¼šç©ºæ•°æ®åº“å®Œæ•´è¿ç§»ï¼Œæœ‰æ•°æ®å®‰å…¨åŒæ­¥
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åŒæ­¥æ—¥å¿— -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>åŒæ­¥æ—¥å¿— <small class="text-muted">(æœ€æ–°10æ¡)</small></h5>
                </div>
                <div class="card-body">
                    <div id="sync-log">
                        <p class="text-muted">æš‚æ— åŒæ­¥æ—¥å¿—</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- é«˜çº§æ¢å¤é€‰é¡¹æ¨¡æ€æ¡† -->
<div class="modal fade" id="advancedRestoreModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cogs me-2"></i>é«˜çº§æ¢å¤é€‰é¡¹
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>æ³¨æ„ï¼š</strong>é«˜çº§æ¢å¤å…è®¸æ‚¨é€‰æ‹©è¦æ¢å¤çš„è¡¨ï¼Œä½†è¯·è°¨æ…æ“ä½œã€‚
                </div>

                <h6>å¯æ¢å¤çš„è¡¨ï¼š</h6>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="roles" id="restore_roles" checked>
                    <label class="form-check-label" for="restore_roles">
                        <strong>roles</strong> - ç”¨æˆ·è§’è‰²é…ç½®
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="tags" id="restore_tags" checked>
                    <label class="form-check-label" for="restore_tags">
                        <strong>tags</strong> - æ´»åŠ¨æ ‡ç­¾é…ç½®
                    </label>
                </div>

                <hr>
                <h6 class="text-danger">å±é™©é€‰é¡¹ï¼ˆä¸æ¨èï¼‰ï¼š</h6>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="users" id="restore_users">
                    <label class="form-check-label text-danger" for="restore_users">
                        <strong>users</strong> - ç”¨æˆ·è´¦æˆ·æ•°æ® âš ï¸
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="activities" id="restore_activities">
                    <label class="form-check-label text-danger" for="restore_activities">
                        <strong>activities</strong> - æ´»åŠ¨æ•°æ® âš ï¸
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-warning" onclick="executeAdvancedRestore()">
                    <i class="fas fa-cloud-download-alt me-2"></i>æ‰§è¡Œæ¢å¤
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// åˆ·æ–°æ•°æ®åº“çŠ¶æ€
function refreshStatus() {
    checkDatabaseStatus();
    loadSyncLog();
}



// è¯·æ±‚å»é‡å’Œé¢‘ç‡æ§åˆ¶
let isCheckingStatus = false;
let lastStatusCheck = 0;
const STATUS_CHECK_COOLDOWN = 10000; // 10ç§’å†·å´æ—¶é—´

// æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
function checkDatabaseStatus() {
    const now = Date.now();

    // é˜²æ­¢é‡å¤è¯·æ±‚
    if (isCheckingStatus) {
        console.log('æ•°æ®åº“çŠ¶æ€æ£€æŸ¥æ­£åœ¨è¿›è¡Œä¸­ï¼Œè·³è¿‡æ­¤æ¬¡è¯·æ±‚');
        return;
    }

    // é¢‘ç‡é™åˆ¶
    if (now - lastStatusCheck < STATUS_CHECK_COOLDOWN) {
        console.log('æ•°æ®åº“çŠ¶æ€æ£€æŸ¥é¢‘ç‡é™åˆ¶ï¼Œè·³è¿‡æ­¤æ¬¡è¯·æ±‚');
        return;
    }

    isCheckingStatus = true;
    lastStatusCheck = now;

    fetch('/admin/api/database-status')
        .then(response => {
            if (response.status === 429) {
                throw new Error('è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•');
            }

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            // æ£€æŸ¥å“åº”å†…å®¹ç±»å‹
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('æœåŠ¡å™¨è¿”å›äº†éJSONå“åº”');
            }

            return response.json();
        })
        .then(data => {
            updatePrimaryStatus(data);
            updateBackupStatus(data);
        })
        .catch(error => {
            console.error('è·å–æ•°æ®åº“çŠ¶æ€å¤±è´¥:', error);

            if (error.message.includes('429') || error.message.includes('é¢‘ç¹')) {
                console.log('APIè¯·æ±‚é¢‘ç‡è¿‡é«˜ï¼Œæš‚åœçŠ¶æ€æ£€æŸ¥');
                // æš‚åœæ›´é•¿æ—¶é—´
                lastStatusCheck = now + 30000; // é¢å¤–æš‚åœ30ç§’
            } else if (!error.message.includes('JSON')) {
                // åªåœ¨éJSONé”™è¯¯æ—¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                showError('è·å–æ•°æ®åº“çŠ¶æ€å¤±è´¥: ' + error.message);
            }
        })
        .finally(() => {
            isCheckingStatus = false;
        });
}

// æ›´æ–°ä¸»æ•°æ®åº“çŠ¶æ€
function updatePrimaryStatus(data) {
    const container = document.getElementById('primary-db-status');
    const isConnected = data.primary;
    const latency = data.primary_latency;
    
    let statusHtml = '';
    if (isConnected) {
        statusHtml = `
            <div class="text-success">
                <i class="fas fa-check-circle fa-2x mb-2"></i>
                <h6>è¿æ¥æ­£å¸¸</h6>
                <p class="mb-0">å»¶è¿Ÿ: ${latency ? latency.toFixed(2) + 'ms' : 'æœªçŸ¥'}</p>
            </div>
        `;
    } else {
        statusHtml = `
            <div class="text-danger">
                <i class="fas fa-times-circle fa-2x mb-2"></i>
                <h6>è¿æ¥å¤±è´¥</h6>
                <p class="mb-0">æ— æ³•è¿æ¥åˆ°ä¸»æ•°æ®åº“</p>
            </div>
        `;
    }
    
    container.innerHTML = statusHtml;
}

// æ›´æ–°å¤‡ä»½æ•°æ®åº“çŠ¶æ€
function updateBackupStatus(data) {
    const container = document.getElementById('backup-db-status');
    const isConnected = data.backup;
    const latency = data.backup_latency;
    
    let statusHtml = '';
    if (data.backup_configured) {
        if (isConnected) {
            statusHtml = `
                <div class="text-success">
                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                    <h6>è¿æ¥æ­£å¸¸</h6>
                    <p class="mb-0">å»¶è¿Ÿ: ${latency ? latency.toFixed(2) + 'ms' : 'æœªçŸ¥'}</p>
                </div>
            `;
        } else {
            statusHtml = `
                <div class="text-danger">
                    <i class="fas fa-times-circle fa-2x mb-2"></i>
                    <h6>è¿æ¥å¤±è´¥</h6>
                    <p class="mb-0">æ— æ³•è¿æ¥åˆ°å¤‡ä»½æ•°æ®åº“</p>
                </div>
            `;
        }
    } else {
        statusHtml = `
            <div class="text-warning">
                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                <h6>æœªé…ç½®</h6>
                <p class="mb-0">å¤‡ä»½æ•°æ®åº“æœªé…ç½®</p>
            </div>
        `;
    }
    
    container.innerHTML = statusHtml;
}

// å…¨å±€å˜é‡å­˜å‚¨å½“å‰å¤‡ä»½ä»»åŠ¡
let currentBackupTask = null;
let backupStatusInterval = null;

// åŒæ­¥åˆ°å¤‡ä»½æ•°æ®åº“ - å¼‚æ­¥ç‰ˆæœ¬
function syncToBackup() {
    const btn = document.getElementById('syncToBackupBtn');
    const originalText = btn.innerHTML;

    // è·å–CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

    if (!csrfToken) {
        showError('æ— æ³•è·å–CSRF token');
        return;
    }

    // å¯åŠ¨å¼‚æ­¥å¤‡ä»½
    fetch('/admin/api/sync-to-backup', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            currentBackupTask = data.task_id;
            showBackupProgress();
            startBackupStatusPolling(data.task_id);
            showSuccess('å¤‡ä»½ä»»åŠ¡å·²å¯åŠ¨ï¼Œæ­£åœ¨åå°æ‰§è¡Œ...');
        } else {
            showError('å¯åŠ¨å¤‡ä»½å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
        }
    })
    .catch(error => {
        console.error('å¯åŠ¨å¤‡ä»½å¤±è´¥:', error);
        showError('å¯åŠ¨å¤‡ä»½å¤±è´¥: ' + error.message);
    });
}

// æ˜¾ç¤ºå¤‡ä»½è¿›åº¦ç•Œé¢
function showBackupProgress() {
    const btn = document.getElementById('syncToBackupBtn');
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>å¤‡ä»½ä¸­...';
    btn.disabled = true;

    // åˆ›å»ºè¿›åº¦æ˜¾ç¤ºåŒºåŸŸ
    const progressContainer = document.getElementById('backup-progress-container');
    if (!progressContainer) {
        const container = document.createElement('div');
        container.id = 'backup-progress-container';
        container.className = 'mt-3';
        container.innerHTML = `
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="fas fa-cloud-upload-alt me-2"></i>å¤‡ä»½è¿›åº¦
                    </h6>
                    <div class="progress mb-2">
                        <div id="backup-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                             role="progressbar" style="width: 0%"></div>
                    </div>
                    <div id="backup-status-text" class="text-muted small">å‡†å¤‡å¼€å§‹...</div>
                    <div id="backup-details" class="mt-2 small text-muted"></div>
                </div>
            </div>
        `;
        btn.parentNode.appendChild(container);
    }
}

// å¼€å§‹è½®è¯¢å¤‡ä»½çŠ¶æ€
function startBackupStatusPolling(taskId) {
    if (backupStatusInterval) {
        clearInterval(backupStatusInterval);
    }

    backupStatusInterval = setInterval(() => {
        checkBackupStatus(taskId);
    }, 2000); // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡
}

// æ£€æŸ¥å¤‡ä»½çŠ¶æ€
function checkBackupStatus(taskId) {
    fetch(`/admin/api/backup-status/${taskId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateBackupProgress(data.status);

            if (data.status.status === 'completed' || data.status.status === 'failed') {
                stopBackupStatusPolling();
                handleBackupComplete(data.status);
            }
        }
    })
    .catch(error => {
        console.error('è·å–å¤‡ä»½çŠ¶æ€å¤±è´¥:', error);
    });
}

// æ›´æ–°å¤‡ä»½è¿›åº¦æ˜¾ç¤º
function updateBackupProgress(status) {
    const progressBar = document.getElementById('backup-progress-bar');
    const statusText = document.getElementById('backup-status-text');
    const detailsText = document.getElementById('backup-details');

    if (progressBar) {
        progressBar.style.width = status.progress + '%';
        progressBar.textContent = status.progress + '%';
    }

    if (statusText) {
        if (status.current_table) {
            statusText.textContent = `æ­£åœ¨åŒæ­¥: ${status.current_table} (${status.completed_tables}/${status.total_tables})`;
        } else {
            statusText.textContent = status.status === 'running' ? 'æ­£åœ¨æ‰§è¡Œ...' : 'å‡†å¤‡ä¸­...';
        }
    }

    if (detailsText && status.total_rows > 0) {
        detailsText.textContent = `å·²å¤„ç† ${status.total_rows} è¡Œæ•°æ®`;
    }
}

// åœæ­¢çŠ¶æ€è½®è¯¢
function stopBackupStatusPolling() {
    if (backupStatusInterval) {
        clearInterval(backupStatusInterval);
        backupStatusInterval = null;
    }
}

// å¤„ç†å¤‡ä»½å®Œæˆ
function handleBackupComplete(status) {
    const btn = document.getElementById('syncToBackupBtn');
    const progressContainer = document.getElementById('backup-progress-container');

    // æ¢å¤æŒ‰é’®çŠ¶æ€
    btn.innerHTML = '<i class="fas fa-cloud-upload-alt me-2"></i>å¤‡ä»½åˆ°ClawCloud';
    btn.disabled = false;

    // ç§»é™¤è¿›åº¦æ˜¾ç¤º
    if (progressContainer) {
        progressContainer.remove();
    }

    // æ˜¾ç¤ºç»“æœ
    if (status.status === 'completed') {
        showSuccess(`å¤‡ä»½æˆåŠŸå®Œæˆï¼åŒæ­¥äº† ${status.total_rows} è¡Œæ•°æ®`);
        loadSyncLog();
    } else {
        showError('å¤‡ä»½å¤±è´¥: ' + (status.error || 'æœªçŸ¥é”™è¯¯'));
    }

    currentBackupTask = null;
}

// æ™ºèƒ½æ•°æ®åº“è¿ç§»
function restoreFromBackup() {
    const confirmMessage = `æ™ºèƒ½æ•°æ®åº“è¿ç§»

ğŸ§  æ™ºèƒ½æ£€æµ‹ç­–ç•¥ï¼š
ç³»ç»Ÿä¼šæ£€æµ‹ä¸šåŠ¡æ•°æ®é‡ï¼Œè‡ªåŠ¨é€‰æ‹©æœ€ä½³è¿ç§»ç­–ç•¥

ğŸ“Š æ–°éƒ¨ç½²æ•°æ®åº“ï¼ˆå°‘é‡åŸºç¡€æ•°æ®ï¼‰ï¼š
â€¢ æ£€æµ‹æ ‡å‡†ï¼šæ— æ´»åŠ¨æ•°æ®ï¼Œç”¨æˆ·â‰¤2ä¸ªï¼Œæ— ä¸šåŠ¡å…³è”
â€¢ å®Œæ•´è¿ç§»ï¼šæ™ºèƒ½å¤„ç†å·²å­˜åœ¨çš„ç®¡ç†å‘˜è´¦å·
â€¢ è¿ç§»å†…å®¹ï¼šè§’è‰²(UPSERT)â†’æ ‡ç­¾â†’ç”¨æˆ·(å»é‡)â†’æ´»åŠ¨â†’å…³è”æ•°æ®
â€¢ é€‚ç”¨åœºæ™¯ï¼šRenderæ•°æ®åº“è¿‡æœŸåçš„å…¨æ–°éƒ¨ç½²

ğŸ“Š æœ‰ä¸šåŠ¡æ•°æ®åº“ï¼ˆç°æœ‰ç³»ç»Ÿï¼‰ï¼š
â€¢ æ£€æµ‹æ ‡å‡†ï¼šæœ‰æ´»åŠ¨æ•°æ®æˆ–è¾ƒå¤šç”¨æˆ·
â€¢ å®‰å…¨åŒæ­¥ï¼šåªåŒæ­¥é…ç½®æ•°æ®ï¼ˆè§’è‰²ã€æ ‡ç­¾ï¼‰
â€¢ ä¿æŠ¤ç­–ç•¥ï¼šä¸å½±å“ç°æœ‰ç”¨æˆ·å’Œæ´»åŠ¨æ•°æ®
â€¢ é€‚ç”¨åœºæ™¯ï¼šé…ç½®åŒæ­¥ï¼Œæ•°æ®ä¿æŠ¤

âœ… æ™ºèƒ½ä¿éšœï¼š
â€¢ è‡ªåŠ¨è¯†åˆ«ç®¡ç†å‘˜è´¦å·ï¼Œé¿å…å†²çª
â€¢ ç”¨æˆ·å»é‡ï¼šåªè¿ç§»ä¸å­˜åœ¨çš„ç”¨æˆ·
â€¢ è§’è‰²UPSERTï¼šæ›´æ–°è€Œä¸è¦†ç›–
â€¢ è¯¦ç»†çš„æ“ä½œçŠ¶æ€åé¦ˆ

ç¡®å®šè¦æ‰§è¡Œæ™ºèƒ½æ•°æ®åº“è¿ç§»å—ï¼Ÿ`;

    if (!confirm(confirmMessage)) {
        return;
    }
    
    const btn = document.getElementById('restoreFromBackupBtn');
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>æ¢å¤ä¸­...';
    btn.disabled = true;
    
    // è·å–CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

    if (!csrfToken) {
        showError('æ— æ³•è·å–CSRF token');
        btn.innerHTML = originalText;
        btn.disabled = false;
        return;
    }

    // åˆ›å»ºAbortControllerç”¨äºè¶…æ—¶æ§åˆ¶
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 180000); // 3åˆ†é’Ÿè¶…æ—¶

    fetch('/admin/api/restore-from-backup', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        signal: controller.signal
    })
    .then(response => {
        clearTimeout(timeoutId);

        // æ£€æŸ¥å“åº”çŠ¶æ€
        if (response.status === 524) {
            throw new Error('è¯·æ±‚è¶…æ—¶ï¼Œä½†æ¢å¤å¯èƒ½ä»åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç¨åæŸ¥çœ‹åŒæ­¥æ—¥å¿—');
        }

        if (response.status === 523) {
            throw new Error('æœåŠ¡å™¨æš‚æ—¶ä¸å¯è¾¾ï¼Œæ¢å¤å¯èƒ½ä»åœ¨åå°è¿›è¡Œï¼Œè¯·ç¨åæŸ¥çœ‹åŒæ­¥æ—¥å¿—');
        }

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        // æ£€æŸ¥å“åº”å†…å®¹ç±»å‹
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('æœåŠ¡å™¨è¿”å›äº†éJSONå“åº”ï¼Œå¯èƒ½æ˜¯HTMLé”™è¯¯é¡µé¢');
        }

        return response.json();
    })
    .then(data => {
        if (data.success) {
            showSuccess('æ•°æ®å·²ä»ClawCloudæˆåŠŸæ¢å¤');
            loadSyncLog();
        } else {
            showError('æ¢å¤å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
        }
    })
    .catch(error => {
        clearTimeout(timeoutId);
        console.error('æ¢å¤å¤±è´¥:', error);

        if (error.name === 'AbortError') {
            showError('æ¢å¤è¯·æ±‚è¶…æ—¶ï¼Œä½†æ“ä½œå¯èƒ½ä»åœ¨åå°è¿›è¡Œï¼Œè¯·ç¨åæŸ¥çœ‹åŒæ­¥æ—¥å¿—');
        } else if (error.message.includes('524') || error.message.includes('è¶…æ—¶')) {
            showError('æ¢å¤è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åæŸ¥çœ‹åŒæ­¥æ—¥å¿—ç¡®è®¤ç»“æœ');
        } else if (error.message.includes('523') || error.message.includes('ä¸å¯è¾¾')) {
            showError('æœåŠ¡å™¨æš‚æ—¶ä¸å¯è¾¾ï¼Œæ¢å¤å¯èƒ½ä»åœ¨åå°è¿›è¡Œï¼Œè¯·ç¨åæŸ¥çœ‹åŒæ­¥æ—¥å¿—');
        } else if (error.message.includes('JSON')) {
            showError('æœåŠ¡å™¨å“åº”æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€');
        } else {
            showError('æ¢å¤æ“ä½œå¤±è´¥: ' + error.message);
        }

        // è¶…æ—¶ååˆ·æ–°åŒæ­¥æ—¥å¿—ï¼Œå¯èƒ½æ“ä½œå·²å®Œæˆ
        setTimeout(() => {
            loadSyncLog();
        }, 5000);
    })
    .finally(() => {
        clearTimeout(timeoutId);
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

// æ˜¾ç¤ºé«˜çº§æ¢å¤é€‰é¡¹
function showAdvancedRestore() {
    const modal = new bootstrap.Modal(document.getElementById('advancedRestoreModal'));
    modal.show();
}

// æ‰§è¡Œé«˜çº§æ¢å¤
function executeAdvancedRestore() {
    const selectedTables = [];
    const checkboxes = document.querySelectorAll('#advancedRestoreModal input[type="checkbox"]:checked');

    checkboxes.forEach(checkbox => {
        selectedTables.push(checkbox.value);
    });

    if (selectedTables.length === 0) {
        alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦æ¢å¤çš„è¡¨');
        return;
    }

    const dangerousTables = selectedTables.filter(table => ['users', 'activities'].includes(table));
    let confirmMessage = `ç¡®å®šè¦æ¢å¤ä»¥ä¸‹è¡¨å—ï¼Ÿ\n\né€‰ä¸­çš„è¡¨ï¼š${selectedTables.join(', ')}`;

    if (dangerousTables.length > 0) {
        confirmMessage += `\n\nâš ï¸ è­¦å‘Šï¼šæ‚¨é€‰æ‹©äº†å±é™©é€‰é¡¹ (${dangerousTables.join(', ')})ï¼Œè¿™å¯èƒ½ä¼šè¦†ç›–é‡è¦æ•°æ®ï¼`;
    }

    if (!confirm(confirmMessage)) {
        return;
    }

    // å…³é—­æ¨¡æ€æ¡†
    const modal = bootstrap.Modal.getInstance(document.getElementById('advancedRestoreModal'));
    modal.hide();

    // æ‰§è¡Œæ¢å¤ï¼ˆè¿™é‡Œå¯ä»¥æ‰©å±•ä¸ºæ”¯æŒé€‰æ‹©æ€§æ¢å¤çš„APIï¼‰
    restoreFromBackup();
}

// åŠ è½½åŒæ­¥æ—¥å¿—
function loadSyncLog() {
    fetch('/admin/api/sync-log')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('sync-log');
            if (data.logs && data.logs.length > 0) {
                let logHtml = '<div class="table-responsive"><table class="table table-sm">';
                logHtml += '<thead><tr><th>æ—¶é—´ <i class="fas fa-sort-down text-muted" title="æœ€æ–°åœ¨å‰"></i></th><th>æ“ä½œ</th><th>çŠ¶æ€</th><th>è¯¦æƒ…</th></tr></thead><tbody>';
                
                // åç«¯å·²ç»æŒ‰æ—¶é—´å€’åºæ’åˆ—ï¼Œç›´æ¥å–å‰10æ¡å³å¯ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                data.logs.slice(0, 10).forEach(log => {
                    const statusClass = log.status === 'æˆåŠŸ' ? 'text-success' :
                                       log.status === 'å¤±è´¥' ? 'text-danger' : 'text-warning';

                    // å¼ºåˆ¶åŒ—äº¬æ—¶é—´æ˜¾ç¤º - ç®€åŒ–ä¸”æ›´å¯é çš„æ–¹æ³•
                    let beijingTime;
                    try {
                        let timestamp;



                        // å…³é”®ä¿®å¤ï¼šæ­£ç¡®å¤„ç†æ—¶åŒºè½¬æ¢
                        if (log.timestamp.includes('+08:00') || log.timestamp.includes('+0800')) {
                            // å·²åŒ…å«æ—¶åŒºä¿¡æ¯ï¼Œç›´æ¥è§£æ
                            timestamp = new Date(log.timestamp);
                        } else {
                            // æ²¡æœ‰æ—¶åŒºä¿¡æ¯ï¼Œè¿™äº›æ—¶é—´æˆ³å®é™…ä¸Šæ˜¯UTCæ—¶é—´ï¼Œéœ€è¦è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´
                            timestamp = new Date(log.timestamp + 'Z'); // æ·»åŠ Zè¡¨ç¤ºUTCæ—¶é—´

                            // å¦‚æœè§£æå¤±è´¥ï¼Œå°è¯•å…¶ä»–æ ¼å¼
                            if (isNaN(timestamp.getTime())) {
                                // å°è¯•ç›´æ¥è§£æ
                                timestamp = new Date(log.timestamp);

                                // å¦‚æœä»ç„¶å¤±è´¥ï¼Œå°è¯•æ ‡å‡†åŒ–æ ¼å¼
                                if (isNaN(timestamp.getTime())) {
                                    let timeStr = log.timestamp.replace(' ', 'T');
                                    timestamp = new Date(timeStr + 'Z');
                                }
                            }
                        }

                        // æœ€ç»ˆéªŒè¯
                        if (isNaN(timestamp.getTime())) {
                            throw new Error('æ— æ³•è§£ææ—¶é—´æˆ³');
                        }

                        // å¼ºåˆ¶æ˜¾ç¤ºä¸ºåŒ—äº¬æ—¶é—´
                        beijingTime = timestamp.toLocaleString('zh-CN', {
                            timeZone: 'Asia/Shanghai',
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            hour12: false
                        });



                    } catch (e) {
                        console.error('æ—¶é—´è§£æå¤±è´¥:', log.timestamp, e);
                        // å¦‚æœæ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥ï¼Œç›´æ¥æ˜¾ç¤ºåŸå§‹æ—¶é—´æˆ³
                        beijingTime = log.timestamp;
                    }

                    logHtml += `
                        <tr>
                            <td>${beijingTime}</td>
                            <td>${log.action}</td>
                            <td class="${statusClass}">${log.status}</td>
                            <td>${log.details || '-'}</td>
                        </tr>
                    `;
                });
                
                logHtml += '</tbody></table></div>';
                container.innerHTML = logHtml;
            } else {
                container.innerHTML = '<p class="text-muted">æš‚æ— åŒæ­¥æ—¥å¿—</p>';
            }
        })
        .catch(error => {
            console.error('åŠ è½½åŒæ­¥æ—¥å¿—å¤±è´¥:', error);
        });
}

// æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
function showSuccess(message) {
    if (typeof showToast === 'function') {
        showToast(message, 'success');
    } else {
        alert(message);
    }
}

// æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
function showError(message) {
    if (typeof showToast === 'function') {
        showToast(message, 'error');
    } else {
        alert(message);
    }
}

// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çŠ¶æ€
document.addEventListener('DOMContentLoaded', function() {
    checkDatabaseStatus();
    loadSyncLog();

    // æ¯2åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°çŠ¶æ€ï¼ˆå‡å°‘APIè¯·æ±‚é¢‘ç‡ï¼‰
    setInterval(checkDatabaseStatus, 120000);

    // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶æ£€æŸ¥çŠ¶æ€
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible') {
            // é¡µé¢å˜ä¸ºå¯è§æ—¶ï¼Œå»¶è¿Ÿ5ç§’åæ£€æŸ¥çŠ¶æ€
            setTimeout(checkDatabaseStatus, 5000);
        }
    });
});
</script>
{% endblock %}
