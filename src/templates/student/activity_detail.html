{% extends 'base.html' %}

{% block title %}{{ activity.title }} - 重庆师范大学师能素质协会{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- 添加CSRF令牌到页面头部 -->
    <meta name="csrf-token" content="{{ csrf_token() }}">
    
    <div class="row">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h2 class="fw-bold mb-3">{{ activity.title }}</h2>
                    <div class="d-flex align-items-center mb-4">
                        <span class="badge {% if activity.status == 'active' %}bg-success{% elif activity.status == 'completed' %}bg-secondary{% else %}bg-danger{% endif %} rounded-pill px-3 py-2 me-3">
                            {% if activity.status == 'active' %}进行中{% elif activity.status == 'completed' %}已结束{% else %}已取消{% endif %}
                        </span>
                        <div class="text-muted">
                            <i class="fas fa-user me-1"></i> 发布者: 管理员
                        </div>
                    </div>

                    {% if activity.poster_image or poster_url or activity.poster_data %}
                        <div class="mb-4 text-center">
                            {% if activity.poster_data %}
                            <img src="{{ url_for('main.poster_image', activity_id=activity.id) }}" alt="活动海报" class="img-fluid rounded shadow-sm" style="max-height: 400px;">
                            {% elif poster_url %}
                            <img src="{{ poster_url }}" alt="活动海报" class="img-fluid rounded shadow-sm" style="max-height: 400px;">
                            {% elif 'banner' in activity.poster_image %}
                            <img src="{{ url_for('static', filename='img/' + activity.poster_image) }}" alt="活动海报" class="img-fluid rounded shadow-sm" style="max-height: 400px;">
                            {% else %}
                            <img src="{{ url_for('static', filename='img/landscape.jpg') }}" alt="活动海报" class="img-fluid rounded shadow-sm" style="max-height: 400px;">
                            {% endif %}
                        </div>
                    {% endif %}

                    <h5 class="fw-bold mb-3">活动描述</h5>
                    <div class="activity-description mb-4">
                        {{ activity.description|safe }}
                    </div>

                    <div id="action-buttons" class="d-flex justify-content-between align-items-center flex-wrap">
                        <div class="mb-3 mb-md-0">
                            {% if has_registered %}
                                <span class="badge bg-success rounded-pill px-3 py-2 me-2">
                                    <i class="fas fa-check-circle me-1"></i>已报名
                                </span>
                                {% if can_cancel %}
                                    <button id="cancel-btn" class="btn btn-outline-danger">
                                        <i class="fas fa-times-circle me-1"></i>取消报名
                                    </button>
                                {% endif %}
                                {% if can_checkin %}
                                    <button type="button" class="btn btn-success" onclick="showQRScanner()">
                                        <i class="fas fa-qrcode me-1"></i>扫码签到
                                    </button>
                                {% elif has_checked_in %}
                                    <span class="badge bg-info rounded-pill px-3 py-2">
                                        <i class="fas fa-clipboard-check me-1"></i>已签到
                                    </span>
                                {% endif %}
                            {% elif can_register %}
                                <button id="register-btn" class="btn btn-primary">
                                    <i class="fas fa-user-plus me-1"></i>立即报名
                                </button>
                            {% elif activity.status == 'active' and (activity.registration_deadline and safe_greater_than_equal(activity.registration_deadline, now)) %}
                                {% if activity.max_participants > 0 and registered_count >= activity.max_participants %}
                                    <button class="btn btn-secondary" disabled>
                                        <i class="fas fa-users-slash me-1"></i>名额已满
                                    </button>
                                {% endif %}
                            {% else %}
                                <button class="btn btn-secondary" disabled>
                                    <i class="fas fa-hourglass-end me-1"></i>报名已截止
                                </button>
                            {% endif %}
                        </div>
                        <a href="{{ url_for('student.activities') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-1"></i>返回活动列表
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h5 class="fw-bold mb-3">活动信息</h5>
                    <ul class="list-unstyled">
                        <li class="mb-3"><i class="fas fa-map-marker-alt text-primary me-2"></i> <strong>地点:</strong> {{ activity.location }}</li>
                        <li class="mb-3"><i class="fas fa-clock text-primary me-2"></i> <strong>时间:</strong> {{ display_datetime(activity.start_time) }} 至 {{ display_datetime(activity.end_time) }}</li>
                        <li class="mb-3"><i class="fas fa-hourglass-end text-primary me-2"></i> <strong>报名截止:</strong> {{ display_datetime(activity.registration_deadline) }}</li>
                        <li><i class="fas fa-users text-primary me-2"></i> <strong>人数:</strong> 
                            {% if activity.max_participants > 0 %}
                                <span id="registration-count">{{ registered_count }}</span>/{{ activity.max_participants }}
                            {% else %}
                                <span id="registration-count">{{ registered_count }}</span> (不限)
                            {% endif %}
                        </li>
                    </ul>
                </div>
            </div>
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <h5 class="fw-bold mb-3">活动评价</h5>
                    {% if reviews %}
                        <div class="text-center mb-3">
                            <h2 class="display-4 text-primary mb-0 fw-bold">{{ average_rating|round(1) }}</h2>
                            <div class="text-warning">
                                {% for i in range(5) %}
                                    {% if i < average_rating|round(0, 'floor') %}
                                        <i class="fas fa-star"></i>
                                    {% elif i < average_rating %}
                                        <i class="fas fa-star-half-alt"></i>
                                    {% else %}
                                        <i class="far fa-star"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <small class="text-muted">{{ reviews|length }} 条评价</small>
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-comment-slash fs-2 mb-2"></i>
                            <p>暂无评价</p>
                        </div>
                    {% endif %}
                    {% if activity.status == 'completed' and has_attended and not current_user_review %}
                        <a href="{{ url_for('student.review_activity', activity_id=activity.id) }}" class="btn btn-outline-primary w-100 mt-3">
                            <i class="fas fa-star me-1"></i>写评价
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
// QR扫描器代码
let html5QrcodeScanner = null;

function showQRScanner() {
    // 创建QR扫描器容器
    if (!document.getElementById('qr-reader')) {
        const qrContainer = document.createElement('div');
        qrContainer.id = 'qr-reader-container';
        qrContainer.className = 'modal fade';
        qrContainer.setAttribute('tabindex', '-1');
        qrContainer.innerHTML = `
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">扫描签到二维码</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭" onclick="closeQRScanner()"></button>
                    </div>
                    <div class="modal-body">
                        <div id="qr-reader" style="width: 100%"></div>
                        <div class="mt-3">
                            <button id="switch-camera-btn" class="btn btn-sm btn-secondary">切换摄像头</button>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closeQRScanner()">关闭</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(qrContainer);
        
        // 创建Bootstrap模态框
        const qrModal = new bootstrap.Modal(document.getElementById('qr-reader-container'));
        qrModal.show();
        
        // 创建QR扫描器
        html5QrcodeScanner = new Html5Qrcode("qr-reader");
        
        // 获取可用摄像头
        Html5Qrcode.getCameras().then(devices => {
            if (devices && devices.length) {
                let cameraId = devices[0].id;
                
                // 启动扫描器
                startScanner(cameraId);
                
                // 设置切换摄像头按钮
                const switchBtn = document.getElementById('switch-camera-btn');
                let currentCameraIndex = 0;
                
                if (switchBtn && devices.length > 1) {
                    switchBtn.addEventListener('click', () => {
                        // 停止当前扫描
                        html5QrcodeScanner.stop().then(() => {
                            // 切换到下一个摄像头
                            currentCameraIndex = (currentCameraIndex + 1) % devices.length;
                            cameraId = devices[currentCameraIndex].id;
                            
                            // 更新按钮文本
                            switchBtn.textContent = `切换摄像头 (${currentCameraIndex + 1}/${devices.length})`;
                            
                            // 启动新的扫描
                            startScanner(cameraId);
                        }).catch(err => {
                            console.error('切换摄像头失败:', err);
                            showToast('切换摄像头失败，请重试', 'danger');
                        });
                    });
                    
                    // 初始化按钮文本
                    switchBtn.textContent = `切换摄像头 (1/${devices.length})`;
                } else if (switchBtn) {
                    // 如果只有一个摄像头，禁用按钮
                    switchBtn.disabled = true;
                    switchBtn.textContent = '没有其他摄像头';
                }
            } else {
                showToast('未检测到摄像头', 'danger');
            }
        }).catch(err => {
            console.error('获取摄像头列表失败:', err);
            showToast('获取摄像头失败: ' + err.message, 'danger');
        });
    } else {
        // 如果已经存在，则显示模态框
        const qrModal = new bootstrap.Modal(document.getElementById('qr-reader-container'));
        qrModal.show();
    }
}

function startScanner(cameraId) {
    const config = { 
        fps: 10,
        qrbox: { width: 250, height: 250 },
        formatsToSupport: [ Html5QrcodeSupportedFormats.QR_CODE ]
    };
    
    html5QrcodeScanner.start(
        cameraId, 
        config,
        onScanSuccess,
        onScanError
    ).catch(err => {
        console.error("启动扫描器失败:", err);
        showToast('启动摄像头失败: ' + err.message, 'danger');
    });
}

function closeQRScanner() {
    if (html5QrcodeScanner) {
        html5QrcodeScanner.stop().then(() => {
            console.log('QR扫描器已关闭');
            // 移除模态框
            const container = document.getElementById('qr-reader-container');
            if (container) {
                container.remove();
            }
        }).catch(err => {
            console.error('关闭QR扫描器失败:', err);
        });
    }
}

function onScanSuccess(decodedText, decodedResult) {
    console.log(`扫码成功: ${decodedText}`, decodedResult);
    
    // 停止扫描
    html5QrcodeScanner.pause();
    
    // 提取活动ID和签到码
    let activityId = {{ activity.id }};
    let checkinKey = decodedText;
    
    // 尝试解析二维码内容
    try {
        // 检查是否是JSON格式
        if (decodedText.startsWith('{') && decodedText.endsWith('}')) {
            const jsonData = JSON.parse(decodedText);
            if (jsonData.activity_id) {
                activityId = jsonData.activity_id;
            }
            if (jsonData.key) {
                checkinKey = jsonData.key;
            }
        }
        // 检查是否是URL格式
        else if (decodedText.startsWith('http')) {
            // 继续使用原始文本作为签到码
        }
    } catch (e) {
        console.warn('解析二维码内容失败，使用原始文本:', e);
    }
    
    // 获取CSRF令牌
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    console.log('使用CSRF令牌:', csrfToken);
    
    // 发送签到请求
    fetch('/student/api/attendance/checkin', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            activity_id: activityId,
            checkin_key: checkinKey
        })
    })
    .then(response => {
        if (!response.ok) {
            console.error('签到请求失败:', response.status, response.statusText);
            throw new Error(`网络请求失败: ${response.status} ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast('签到成功！' + (data.points ? `获得${data.points}积分` : ''), 'success');
            // 关闭扫描器
            closeQRScanner();
            // 延迟1秒后刷新页面
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showToast(data.message || '签到失败', 'danger');
            // 恢复扫描
            html5QrcodeScanner.resume();
        }
    })
    .catch(error => {
        console.error('签到请求失败:', error);
        showToast('网络错误，请重试', 'danger');
        // 恢复扫描
        html5QrcodeScanner.resume();
    });
}

function onScanError(err) {
    // 不处理常规扫描错误
    console.debug('扫码错误 (正常):', err);
}

// 显示Toast通知
function showToast(message, type = 'info') {
    // 检查是否已存在Toast容器
    let toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(toastContainer);
    }
    
    // 创建Toast元素
    const toastId = 'toast-' + Date.now();
    const toastEl = document.createElement('div');
    toastEl.className = `toast align-items-center text-white bg-${type} border-0`;
    toastEl.setAttribute('role', 'alert');
    toastEl.setAttribute('aria-live', 'assertive');
    toastEl.setAttribute('aria-atomic', 'true');
    toastEl.setAttribute('id', toastId);
    
    toastEl.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="关闭"></button>
        </div>
    `;
    
    // 添加到容器
    toastContainer.appendChild(toastEl);
    
    // 初始化Toast
    const toast = new bootstrap.Toast(toastEl, {
        autohide: true,
        delay: 3000
    });
    
    // 显示Toast
    toast.show();
    
    // 监听隐藏事件，移除元素
    toastEl.addEventListener('hidden.bs.toast', () => {
        toastEl.remove();
    });
}
</script>
{% endblock %}

